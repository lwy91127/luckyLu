title: 微信H5支付开发
date: 2015-12-08 10:31:51
tags: web开发
---

### 微信H5支付开发过程

1. 将产品链接urlencode后替换下面的redirect_uri的值，然后将整个链接生成二维码或直接发给用户
```
https://open.weixin.qq.com/connect/oauth2/authorize?appid=XXX&redirect_uri=XXX&response_type=code&scope=snsapi_userinfo#wechat_redirect
```
2. 获取返回信息中的code字段，通过ajax发送异步请求到下面地址，替换其中code字段值
```
https://api.weixin.qq.com/sns/oauth2/access_token?appid=XXX&secret=XXX&code=CODE&grant_type=authorization_code
```
<!--more-->

3. 再通过返回的openid创建type为jsapi的统一订单（2小时有效期）

4. 获取统一订单创建后返回的prepay_id字段加入到jssdk中进行支付请求

``` js
function onBridgeReady(){
			   WeixinJSBridge.invoke(
			       'getBrandWCPayRequest', {
			           "appId" ： "wx2421b1c4370ec43b",     //公众号名称，由商户传入     
			           "timeStamp"：new Date().getTime(),         //时间戳，自1970年以来的秒数     
			           "nonceStr" ： "e61463f8efa94090b1f366cccfbbb444", //随机串     
			           "package" ： "prepay_id=u802345jgfjsdfgsdg888",     
			           "signType" ： "MD5",         //微信签名方式：     
			           "paySign" ： "70EA570631E4BB79628FBCA90534C63FF7FADD89" //微信签名
			       },
			       function(res){     
			           if(res.err_msg == "get_brand_wcpay_request：ok" ) {}     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
			       }
			   );
		}
function pay(){
		if (typeof WeixinJSBridge == "undefined"){
		   if( document.addEventListener ){
		       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
		   }else if (document.attachEvent){
		       document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
		       document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
		   }
		}else{
		   onBridgeReady();
		}
}
```
> notes:  paySign签名时注意参数的名称与统一下单接口参数不同

#### 问题列表：

 - redirect_uri问题
 > 微信公众平台->开发者中心->网页服务->网页账号修改->地址修改为服务器地址

 - 支付目录授权
 > 微信公众平台->微信支付->开发配置->支付授权目录配置

 - JS接口安全授权 
